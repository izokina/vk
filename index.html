<html>
 <head>
  <title>VK</title>
  <script src="//vk.com/js/api/openapi.js" type="text/javascript"></script>
  <style>
body {
  background-color : #ddddff;
}
#log, #log > div {
  border-style : solid;
  border-width : 1px;
}
#log {
  padding : 5px;
  background-color : #ffffee;
  border-color : #ffff00;
}
#log > div {
  margin : 8px;
  padding : 8px;
  background-color : #ddffcc;
  border-color : #55ff00;
}
#log > div.error {
  background-color : #ff9955;
  border-color : #ff0000;
}
#log > div > div > .user {
  margin-right : 13px;
  background-color : #bbff99;
}
#log > div > div > .stamp {
  color : #777777;
}
  </style>
 </head>
 <body>
  <script type="text/javascript">
    VK.init({
      apiId: 1943647
    });
    var ME = {};
    ME.log = function(builder) {
      var el = document.createElement('div');
      builder(el);
      document.getElementById('log').appendChild(el);
    }
    ME.logText = function(text) {
      ME.log(function(el) {
        el.textContent = text;
      });
    };
    ME.logError = function(text) {
      ME.log(function(el) {
        el.textContent = text;
        el.className = 'error';
      });
    };
    ME.logStatus = function(name, text) {
      ME.log(function(el) {
        var user = document.createElement('span');
        user.className = 'user';
        user.textContent = name;
        var stamp = document.createElement('span');
        stamp.className = 'stamp';
        stamp.textContent = new Date().toLocaleString();
        var header = document.createElement('div');
        header.appendChild(user);
        header.appendChild(stamp);
        var message = document.createElement('div');
        message.textContent = text;
        el.appendChild(header);
        el.appendChild(message);
      });
    }
    ME.getStatus = function(id, action) {
      VK.Api.call('status.get', { user_id : id }, function(r) {
        if (r.response) {
          action(r.response.text);
        } else {
          if (r.error && r.error.error_code != 6)
            ME.logError('Error on getting status for "' + id + '": ' + r.error.error_msg);
        }
      });
    }
    ME.auth = function() {
      VK.Auth.login(function(response) {
        if (response.session) {
          ME.logText('Hi there! Reload page if you have some hashed users, or just add new ones.');
        } else {
          ME.logError('Auth failed!');
        }
      }, 1024);
    };
    ME.watchStatus = function(id) {
      var startWatching = function(id, name) {
        var cur;
        var checkUpdate = function() {
          ME.getStatus(id, function(text) {
            if (text != cur) {
              cur = text;
              ME.logStatus(name, cur);
            }
          });
          setTimeout(checkUpdate, 1000);
        }
        checkUpdate();
      }
      var addUsers = function() {
        VK.Api.call('users.get', { user_ids : id }, function(r) {
          if (r.response) {
            for (var i = 0; i < r.response.length; i++) {
              var user = r.response[i];
              startWatching(user.uid, user.first_name + ' ' + user.last_name);
            }
          } else {
            if (r.error) {
              if (r.error.error_code == 6) {
                setTimeout(addUsers, 100);
              } else {
                ME.logError('Couldn\'t start watching "' + id + '": ' + r.error.error_msg);
              }
            }
          }
        });
      }
      addUsers();
    }
    if (window.location.hash) {
      ME.watchStatus(window.location.hash.substring(1));
    }
  </script>
  <form>
   <input type='button' value='Auth' onClick='ME.auth()'/>
  </form>
  <form onsubmit='ME.watchStatus(document.getElementById("statusId").value); return false;'>
   <input type='text' id='statusId'/>
   <input type='submit' value='Start watching'/>
  </form>
  <div id='log'>
  </div>
 </body>
</html>
